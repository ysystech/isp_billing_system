{# Reusable Map Widget Component #}
{# Usage: {% include 'components/map_widget.html' with form=form %} #}

<div x-data="mapWidget(
    '{{ form.latitude.value|default:'' }}',
    '{{ form.longitude.value|default:'' }}',
    '{{ form.instance.location_accuracy|default:'manual' }}',
    '{{ form.instance.location_notes|default:'' }}'
)" x-init="initMap()" class="space-y-4">
    
    {# Map Container #}
    <div class="rounded-lg border border-base-300 overflow-hidden">
        <div id="map-{{ form.instance.pk|default:'new' }}" style="height: 400px;" class="w-full"></div>
    </div>
    
    {# Map Controls #}
    <div class="flex flex-wrap gap-2">
        <button type="button" @click="getCurrentLocation()" class="btn btn-sm btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Use My Location
        </button>
        <button type="button" @click="clearLocation()" class="btn btn-sm btn-outline btn-error" x-show="hasCoordinates">
            Clear Location
        </button>
    </div>
    
    {# Coordinate Display and Manual Input #}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="label" for="{{ form.latitude.id_for_label }}">
                <span class="label-text">Latitude</span>
            </label>
            <input type="number" 
                   id="{{ form.latitude.id_for_label }}"
                   name="{{ form.latitude.name }}"
                   x-model="lat"
                   @change="updateMapFromInputs()"
                   step="any"
                   min="-90"
                   max="90"
                   placeholder="8.4542"
                   class="input input-bordered w-full"
                   {% if form.latitude.field.required %}required{% endif %}>
            {% if form.latitude.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.latitude.errors.0 }}</span>
                </label>
            {% endif %}
        </div>
        
        <div>
            <label class="label" for="{{ form.longitude.id_for_label }}">
                <span class="label-text">Longitude</span>
            </label>
            <input type="number" 
                   id="{{ form.longitude.id_for_label }}"
                   name="{{ form.longitude.name }}"
                   x-model="lng"
                   @change="updateMapFromInputs()"
                   step="any"
                   min="-180"
                   max="180"
                   placeholder="124.6319"
                   class="input input-bordered w-full"
                   {% if form.longitude.field.required %}required{% endif %}>
            {% if form.longitude.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ form.longitude.errors.0 }}</span>
                </label>
            {% endif %}
        </div>
    </div>
    
    {# Location Accuracy and Notes - Hidden, will be shown if we keep them #}
    <input type="hidden" 
           name="{{ form.location_accuracy.name }}" 
           x-model="locationAccuracy"
           value="{{ form.location_accuracy.value|default:'manual' }}">
    
    <input type="hidden" 
           name="{{ form.location_notes.name }}" 
           value="{{ form.location_notes.value|default:'' }}">
    
    <div class="text-sm text-base-content/70">
        <p>Click on the map to set location, or enter coordinates manually above.</p>
    </div>
</div>

<script>
function mapWidget(initialLat, initialLng, initialAccuracy, initialNotes) {
    return {
        map: null,
        marker: null,
        searchControl: null,
        lat: initialLat || '',
        lng: initialLng || '',
        locationAccuracy: initialAccuracy || 'manual',
        locationNotes: initialNotes || '',
        
        get hasCoordinates() {
            return this.lat && this.lng;
        },
        
        initMap() {
            // Initialize map centered on CDO
            const defaultLat = this.lat || 8.4542;
            const defaultLng = this.lng || 124.6319;
            const defaultZoom = this.hasCoordinates ? 16 : 13;
            
            // Create map
            this.map = L.map('map-{{ form.instance.pk|default:"new" }}').setView([defaultLat, defaultLng], defaultZoom);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(this.map);
            
            // Add search control
            this.searchControl = new L.Control.Search({
                url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}',
                jsonpParam: 'json_callback',
                propertyName: 'display_name',
                propertyLoc: ['lat','lon'],
                marker: false,
                moveToLocation: function(latlng, title, map) {
                    map.setView(latlng, 17);
                    return false; // Don't add marker, we'll handle it
                },
                autoType: false,
                minLength: 2,
                position: 'topright'
            });
            
            // Handle search result selection
            this.searchControl.on('search:locationfound', (e) => {
                this.setLocation(e.latlng.lat, e.latlng.lng, 'address');
            });
            
            this.map.addControl(this.searchControl);
            
            // Add existing marker if we have coordinates
            if (this.hasCoordinates) {
                this.marker = L.marker([this.lat, this.lng]).addTo(this.map);
            }
            
            // Handle map clicks
            this.map.on('click', (e) => {
                this.setLocation(e.latlng.lat, e.latlng.lng, 'manual');
            });
        },
        
        setLocation(lat, lng, accuracy = 'manual') {
            // Update coordinates
            this.lat = lat.toFixed(7);
            this.lng = lng.toFixed(7);
            this.locationAccuracy = accuracy;
            
            // Update or create marker
            if (this.marker) {
                this.marker.setLatLng([lat, lng]);
            } else {
                this.marker = L.marker([lat, lng]).addTo(this.map);
            }
            
            // Center map on new location
            this.map.setView([lat, lng], 16);
        },
        
        getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            // Show loading state
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Getting location...';
            btn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    this.setLocation(position.coords.latitude, position.coords.longitude, 'exact');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                (error) => {
                    alert('Unable to get your location: ' + error.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        },
        
        updateMapFromInputs() {
            const lat = parseFloat(this.lat);
            const lng = parseFloat(this.lng);
            
            if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                this.setLocation(lat, lng, 'manual');
            }
        },
        
        clearLocation() {
            // Clear coordinates
            this.lat = '';
            this.lng = '';
            this.locationAccuracy = 'manual';
            
            // Remove marker
            if (this.marker) {
                this.map.removeLayer(this.marker);
                this.marker = null;
            }
            
            // Reset map view to CDO
            this.map.setView([8.4542, 124.6319], 13);
        }
    }
}
</script>
