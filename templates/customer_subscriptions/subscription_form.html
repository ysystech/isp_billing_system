{% extends "web/app/app_base.html" %}
{% load static %}
{% load form_tags %}

{% block title %}{{ title }}{% endblock %}

{% block app %}
<section class="app-card max-w-4xl mx-auto">
  <!-- Breadcrumb -->
  <div class="text-sm breadcrumbs mb-4">
    <ul>
      <li><a href="{% url 'web:home' %}">Dashboard</a></li>
      <li><a href="{% url 'customer_subscriptions:subscription_list' %}">Subscriptions</a></li>
      <li>{{ title }}</li>
    </ul>
  </div>
  
  <h1 class="pg-title mb-6">{{ title }}</h1>
  
  <form method="post" id="subscriptionForm">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
      <div class="alert alert-error mb-4">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    
    <!-- Customer & Plan Selection -->
    <div class="card bg-base-100 shadow-sm mb-6">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">Customer & Plan</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Customer Installation -->
          <div class="form-control">
            <label for="{{ form.customer_installation.id_for_label }}" class="label">
              <span class="label-text">{{ form.customer_installation.label }}</span>
              <span class="label-text-alt text-error">*</span>
            </label>
            {{ form.customer_installation }}
            {% if form.customer_installation.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.customer_installation.errors.0 }}</span>
            </label>
            {% endif %}
          </div>
          
          <!-- Subscription Plan -->
          <div class="form-control">
            <label for="{{ form.subscription_plan.id_for_label }}" class="label">
              <span class="label-text">{{ form.subscription_plan.label }}</span>
              <span class="label-text-alt text-error">*</span>
            </label>
            {{ form.subscription_plan }}
            {% if form.subscription_plan.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.subscription_plan.errors.0 }}</span>
            </label>
            {% endif %}
          </div>
        </div>
        
        <!-- Active Subscription Alert -->
        <div id="activeSubscriptionAlert" class="alert alert-info mt-4 hidden">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <h3 class="font-bold">Active Subscription Found</h3>
            <div class="text-sm" id="activeSubscriptionMessage"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Payment Details -->
    <div class="card bg-base-100 shadow-sm mb-6">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">Payment Details</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Subscription Type -->
          <div class="form-control">
            <label for="{{ form.subscription_type.id_for_label }}" class="label">
              <span class="label-text">{{ form.subscription_type.label }}</span>
              <span class="label-text-alt text-error">*</span>
            </label>
            {{ form.subscription_type }}
            {% if form.subscription_type.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.subscription_type.errors.0 }}</span>
            </label>
            {% endif %}
          </div>
          
          <!-- Amount -->
          <div class="form-control">
            <label for="{{ form.amount.id_for_label }}" class="label">
              <span class="label-text">{{ form.amount.label }}</span>
              <span class="label-text-alt text-error">*</span>
            </label>
            {{ form.amount }}
            {% if form.amount.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.amount.errors.0 }}</span>
            </label>
            {% endif %}
          </div>
        </div>
        
        <!-- Start Date -->
        <div class="form-control mt-4">
          <label for="{{ form.start_date.id_for_label }}" class="label">
            <span class="label-text">{{ form.start_date.label }}</span>
            <span class="label-text-alt text-error">*</span>
          </label>
          {{ form.start_date }}
          {% if form.start_date.errors %}
          <label class="label">
            <span class="label-text-alt text-error">{{ form.start_date.errors.0 }}</span>
          </label>
          {% endif %}
        </div>
        
        <!-- Preview -->
        <div id="subscriptionPreview" class="mt-6 p-4 bg-base-200 rounded-lg">
          <h3 class="font-bold mb-2">Subscription Preview</h3>
          <div id="previewContent" class="text-sm">
            <p class="text-gray-500">Select a plan and payment type to see preview</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Notes -->
    <div class="card bg-base-100 shadow-sm mb-6">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">Additional Notes</h2>
        <div class="form-control">
          {{ form.notes }}
          {% if form.notes.errors %}
          <label class="label">
            <span class="label-text-alt text-error">{{ form.notes.errors.0 }}</span>
          </label>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Form Actions -->
    <div class="flex justify-end gap-3">
      <a href="{% url 'customer_subscriptions:subscription_list' %}" class="btn btn-ghost">Cancel</a>
      <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
    </div>
  </form>
</section>

<script>
// Plan prices cache
let planPrices = {};

// Check for existing subscription
async function checkExistingSubscription() {
    const installationId = document.getElementById('id_customer_installation').value;
    if (!installationId) return;
    
    try {
        const response = await fetch(`/customer-subscriptions/api/latest-subscription/?installation_id=${installationId}`);
        const data = await response.json();
        
        const alertDiv = document.getElementById('activeSubscriptionAlert');
        const messageDiv = document.getElementById('activeSubscriptionMessage');
        const startDateInput = document.getElementById('id_start_date');
        
        if (data.has_active) {
            alertDiv.classList.remove('hidden');
            messageDiv.innerHTML = `
                Current subscription ends on <strong>${data.end_date_display}</strong>.
                New subscription will start after this date.
            `;
            
            // Update start date
            startDateInput.value = data.end_date.slice(0, 16); // Format for datetime-local
        } else {
            alertDiv.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error checking subscription:', error);
    }
}

// Update amount based on subscription type
async function updateAmountAndPreview() {
    const planId = document.getElementById('id_subscription_plan').value;
    const subscriptionType = document.getElementById('id_subscription_type').value;
    const amountInput = document.getElementById('id_amount');
    
    if (!planId) return;
    
    // Get plan price if not cached
    if (!planPrices[planId]) {
        try {
            const response = await fetch(`/customer-subscriptions/api/plan-price/?plan_id=${planId}`);
            const data = await response.json();
            planPrices[planId] = data.price;
        } catch (error) {
            console.error('Error fetching plan price:', error);
            return;
        }
    }
    
    const planPrice = planPrices[planId];
    
    // Update amount based on type
    if (subscriptionType === 'one_month') {
        amountInput.value = planPrice.toFixed(2);
        amountInput.readOnly = true;
    } else if (subscriptionType === 'fifteen_days') {
        amountInput.value = (planPrice / 2).toFixed(2);
        amountInput.readOnly = true;
    } else {
        amountInput.readOnly = false;
    }
    
    updatePreview();
}

// Update preview
async function updatePreview() {
    const planId = document.getElementById('id_subscription_plan').value;
    const subscriptionType = document.getElementById('id_subscription_type').value;
    const amount = document.getElementById('id_amount').value;
    const startDate = document.getElementById('id_start_date').value;
    
    if (!planId || !subscriptionType || !amount || !startDate) {
        document.getElementById('previewContent').innerHTML = 
            '<p class="text-gray-500">Select all fields to see preview</p>';
        return;
    }
    
    try {
        const response = await fetch('/customer-subscriptions/api/calculate-preview/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                plan_id: planId,
                amount: amount,
                subscription_type: subscriptionType
            })
        });
        
        const preview = await response.json();
        
        if (preview.error) {
            document.getElementById('previewContent').innerHTML = 
                `<p class="text-error">${preview.error}</p>`;
            return;
        }
        
        // Calculate end date
        const start = new Date(startDate);
        const endDate = new Date(start);
        endDate.setDate(endDate.getDate() + preview.days);
        endDate.setHours(endDate.getHours() + preview.hours);
        endDate.setMinutes(endDate.getMinutes() + preview.minutes);
        
        document.getElementById('previewContent').innerHTML = `
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="font-semibold">Amount to Pay:</p>
                    <p class="text-lg">â‚±${preview.amount.toFixed(2)}</p>
                </div>
                <div>
                    <p class="font-semibold">Service Time:</p>
                    <p class="text-lg">${preview.display}</p>
                </div>
                <div>
                    <p class="font-semibold">Start Date:</p>
                    <p>${start.toLocaleString()}</p>
                </div>
                <div>
                    <p class="font-semibold">End Date:</p>
                    <p>${endDate.toLocaleString()}</p>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error calculating preview:', error);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if installation is pre-selected
    const installationSelect = document.getElementById('id_customer_installation');
    if (installationSelect && installationSelect.value) {
        checkExistingSubscription();
    }
    
    // Update preview if form is pre-filled
    updatePreview();
});
</script>
{% endblock %}
