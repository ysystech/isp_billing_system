{% extends "web/app/app_base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block app %}
<section class="app-card" x-data="subscriptionForm()">
  <!-- Breadcrumb -->
  <div class="text-sm breadcrumbs mb-4">
    <ul>
      <li><a href="{% url 'web:home' %}">Dashboard</a></li>
      <li><a href="{% url 'customer_subscriptions:subscription_list' %}">Subscriptions</a></li>
      <li>{{ title }}</li>
    </ul>
  </div>
  
  <div class="p-6">
    <h2 class="text-2xl font-bold mb-6">{{ title }}</h2>
    
    <form method="post">
      {% csrf_token %}
      
      {% if form.non_field_errors %}
        <div class="alert alert-error mb-4">
          {{ form.non_field_errors }}
        </div>
      {% endif %}
      
      <div class="space-y-4">
        <!-- Installation -->
        <div class="form-control">
          <label for="{{ form.installation.id_for_label }}" class="label">
            <span class="label-text">{{ form.installation.label }}</span>
            {% if form.installation.field.required %}
              <span class="label-text-alt text-error">*</span>
            {% endif %}
          </label>
          {{ form.installation }}
          {% if form.installation.help_text %}
          <label class="label">
            <span class="label-text-alt">{{ form.installation.help_text }}</span>
          </label>
          {% endif %}
          {% if form.installation.errors %}
          <label class="label">
            <span class="label-text-alt text-error">{{ form.installation.errors.0 }}</span>
          </label>
          {% endif %}
        </div>

        <!-- Plan -->
        <div class="form-control">
          <label for="{{ form.plan.id_for_label }}" class="label">
            <span class="label-text">{{ form.plan.label }}</span>
            {% if form.plan.field.required %}
              <span class="label-text-alt text-error">*</span>
            {% endif %}
          </label>
          {{ form.plan }}
          {% if form.plan.errors %}
          <label class="label">
            <span class="label-text-alt text-error">{{ form.plan.errors.0 }}</span>
          </label>
          {% endif %}
        </div>

        <!-- Start Date and Amount Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Start Date -->
          <div class="form-control">
            <label for="{{ form.start_date.id_for_label }}" class="label">
              <span class="label-text">{{ form.start_date.label }}</span>
              {% if form.start_date.field.required %}
                <span class="label-text-alt text-error">*</span>
              {% endif %}
            </label>
            {{ form.start_date }}
            {% if form.start_date.help_text %}
            <label class="label">
              <span class="label-text-alt">{{ form.start_date.help_text }}</span>
            </label>
            {% endif %}
            {% if form.start_date.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.start_date.errors.0 }}</span>
            </label>
            {% endif %}
          </div>

          <!-- Amount Paid -->
          <div class="form-control">
            <label for="{{ form.amount_paid.id_for_label }}" class="label">
              <span class="label-text">{{ form.amount_paid.label }}</span>
              {% if form.amount_paid.field.required %}
                <span class="label-text-alt text-error">*</span>
              {% endif %}
            </label>
            {{ form.amount_paid }}
            {% if form.amount_paid.help_text %}
            <label class="label">
              <span class="label-text-alt">{{ form.amount_paid.help_text }}</span>
            </label>
            {% endif %}
            {% if form.amount_paid.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.amount_paid.errors.0 }}</span>
            </label>
            {% endif %}
          </div>
        </div>

        <!-- Calculated End Date Display -->
        <div class="form-control" x-show="selectedPlan && startDate">
          <label class="label">
            <span class="label-text">Subscription End Date</span>
          </label>
          <div class="alert alert-info">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span x-text="endDateDisplay"></span>
          </div>
        </div>

        <!-- Payment Method and Reference Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Payment Method -->
          <div class="form-control">
            <label for="{{ form.payment_method.id_for_label }}" class="label">
              <span class="label-text">{{ form.payment_method.label }}</span>
              {% if form.payment_method.field.required %}
                <span class="label-text-alt text-error">*</span>
              {% endif %}
            </label>
            {{ form.payment_method }}
            {% if form.payment_method.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.payment_method.errors.0 }}</span>
            </label>
            {% endif %}
          </div>

          <!-- Reference Number -->
          <div class="form-control">
            <label for="{{ form.reference_number.id_for_label }}" class="label">
              <span class="label-text">{{ form.reference_number.label }}</span>
            </label>
            {{ form.reference_number }}
            {% if form.reference_number.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.reference_number.errors.0 }}</span>
            </label>
            {% endif %}
          </div>
        </div>

        <!-- Notes -->
        <div class="form-control">
          <label for="{{ form.notes.id_for_label }}" class="label">
            <span class="label-text">{{ form.notes.label }}</span>
          </label>
          {{ form.notes }}
          {% if form.notes.errors %}
          <label class="label">
            <span class="label-text-alt text-error">{{ form.notes.errors.0 }}</span>
          </label>
          {% endif %}
        </div>
      </div>

      <!-- Form Actions -->
      <div class="mt-6 flex justify-end space-x-2">
        <a href="{% url 'customer_subscriptions:subscription_list' %}" class="btn btn-ghost">Cancel</a>
        <button type="submit" class="btn btn-primary">{{ submit_text }}</button>
      </div>
    </form>
  </div>
</section>

<script>
function subscriptionForm() {
  return {
    selectedPlan: null,
    startDate: null,
    amountPaid: null,
    paymentMethod: 'CASH',
    endDateDisplay: '',
    plans: [
      {% for plan in form.fields.plan.queryset %}
        {
          id: {{ plan.id }},
          name: "{{ plan.name }}",
          price: "{{ plan.price }}",
          day_count: {{ plan.day_count }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    
    updatePrice() {
      if (this.selectedPlan) {
        const plan = this.plans.find(p => p.id == this.selectedPlan);
        if (plan) {
          this.amountPaid = plan.price;
          this.updateEndDate();
        }
      }
    },
    
    updateEndDate() {
      if (this.selectedPlan && this.startDate) {
        const plan = this.plans.find(p => p.id == this.selectedPlan);
        if (plan) {
          const start = new Date(this.startDate);
          const end = new Date(start);
          end.setDate(end.getDate() + plan.day_count);
          this.endDateDisplay = `This subscription will expire on ${end.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })}`;
        }
      }
    }
  }
}
</script>
{% endblock %}
