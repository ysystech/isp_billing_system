{% extends "web/app/app_base.html" %}
{% load humanize %}

{% block title %}Area Performance Dashboard{% endblock %}

{% block app %}
<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <a href="{% url 'reports:dashboard' %}" class="btn btn-ghost btn-sm mb-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Reports
      </a>
      <h1 class="text-3xl font-bold text-gray-800">Area Performance Dashboard</h1>
      <p class="text-gray-600">Last 90 days analysis</p>
    </div>
    <div>
      <select class="select select-bordered" onchange="window.location.href='?barangay=' + this.value">
        <option value="">All Areas Overview</option>
        {% for barangay in barangays %}
          <option value="{{ barangay.id }}" {% if selected_barangay and selected_barangay.id == barangay.id %}selected{% endif %}>
            {{ barangay.name }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  {% if selected_barangay %}
    <!-- Selected Area Details -->
    <div class="mb-6">
      <h2 class="text-2xl font-semibold mb-4">{{ selected_barangay.name }} Performance</h2>
      
      <!-- Key Metrics -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="card bg-base-100 shadow-sm">
          <div class="card-body">
            <h3 class="text-sm text-gray-600">Total Customers</h3>
            <p class="text-3xl font-bold">{{ selected_stats.total_customers }}</p>
            <p class="text-sm text-success">{{ selected_stats.active_customers }} active</p>
          </div>
        </div>
        
        <div class="card bg-base-100 shadow-sm">
          <div class="card-body">
            <h3 class="text-sm text-gray-600">Revenue (90 days)</h3>
            <p class="text-2xl font-bold text-success">₱{{ selected_stats.revenue|floatformat:2|intcomma }}</p>
            <p class="text-sm text-gray-500">{{ selected_stats.active_subscriptions }} subscriptions</p>
          </div>
        </div>
        
        <div class="card bg-base-100 shadow-sm">
          <div class="card-body">
            <h3 class="text-sm text-gray-600">Service Issues</h3>
            <p class="text-3xl font-bold">{{ selected_stats.tickets_total }}</p>
            <div class="text-sm">
              <span class="text-success">{{ selected_stats.tickets_resolved }} resolved</span> |
              <span class="text-warning">{{ selected_stats.tickets_pending }} pending</span>
            </div>
          </div>
        </div>
        
        <div class="card bg-base-100 shadow-sm">
          <div class="card-body">
            <h3 class="text-sm text-gray-600">Infrastructure</h3>
            <p class="text-2xl font-bold">{{ selected_stats.port_utilization|floatformat:0 }}%</p>
            <p class="text-sm text-gray-500">{{ selected_stats.used_ports }}/{{ selected_stats.total_ports }} ports used</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Monthly Revenue Trend -->
        <div class="card bg-base-100 shadow-md">
          <div class="card-body">
            <h3 class="card-title text-lg mb-4">Monthly Revenue Trend</h3>
            <canvas id="monthlyTrendChart" height="200"></canvas>
          </div>
        </div>

        <!-- Popular Plans -->
        <div class="card bg-base-100 shadow-md">
          <div class="card-body">
            <h3 class="card-title text-lg mb-4">Popular Plans in Area</h3>
            <div class="space-y-3">
              {% for plan in selected_stats.popular_plans %}
                <div class="flex justify-between items-center">
                  <span class="font-medium">{{ plan.subscription_plan__name }}</span>
                  <span class="badge badge-primary">{{ plan.count }}</span>
                </div>
              {% empty %}
                <p class="text-gray-500 text-center">No subscription data</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Growth Metrics -->
      <div class="card bg-info text-info-content shadow-md mt-6">
        <div class="card-body">
          <h3 class="card-title">Growth Opportunity</h3>
          <p>{{ selected_stats.new_customers }} new customers in the last 90 days</p>
          {% if selected_stats.port_utilization < 50 %}
            <p class="text-sm mt-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
              </svg>
              High growth potential - only {{ selected_stats.port_utilization|floatformat:0 }}% infrastructure utilized
            </p>
          {% endif %}
        </div>
      </div>

  {% else %}
    <!-- All Areas Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Top Revenue Areas -->
      <div class="card bg-base-100 shadow-md">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4 text-success">Top Revenue Areas</h2>
          <div class="space-y-3">
            {% for area in top_revenue %}
              <div class="flex justify-between items-center">
                <a href="?barangay={{ area.barangay.id }}" class="link link-hover">{{ area.barangay.name }}</a>
                <span class="font-bold">₱{{ area.revenue|floatformat:2|intcomma }}</span>
              </div>
            {% empty %}
              <p class="text-gray-500">No data</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Low Penetration Areas -->
      <div class="card bg-base-100 shadow-md">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4 text-warning">Growth Opportunities</h2>
          <p class="text-sm text-gray-600 mb-3">Areas with low market penetration</p>
          <div class="space-y-3">
            {% for area in low_penetration %}
              <div class="flex justify-between items-center">
                <a href="?barangay={{ area.barangay.id }}" class="link link-hover">{{ area.barangay.name }}</a>
                <div class="text-right">
                  <span class="badge badge-warning">{{ area.penetration_rate|floatformat:0 }}%</span>
                  <span class="text-xs text-gray-500">{{ area.active_customers }} customers</span>
                </div>
              </div>
            {% empty %}
              <p class="text-gray-500">No data</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- High Issue Areas -->
      <div class="card bg-base-100 shadow-md">
        <div class="card-body">
          <h2 class="card-title text-lg mb-4 text-error">Attention Needed</h2>
          <p class="text-sm text-gray-600 mb-3">Areas with most service issues</p>
          <div class="space-y-3">
            {% for area in high_issues %}
              <div class="flex justify-between items-center">
                <a href="?barangay={{ area.barangay.id }}" class="link link-hover">{{ area.barangay.name }}</a>
                <span class="badge badge-error">{{ area.tickets }} issues</span>
              </div>
            {% empty %}
              <p class="text-gray-500">No issues reported</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- All Areas Table -->
    <div class="card bg-base-100 shadow-md">
      <div class="card-body">
        <h2 class="card-title text-lg mb-4">All Areas Performance</h2>
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>Barangay</th>
                <th>Total Customers</th>
                <th>Active</th>
                <th>Revenue (90d)</th>
                <th>Issues</th>
                <th>Penetration</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for area in area_stats %}
                <tr class="hover">
                  <td class="font-medium">{{ area.barangay.name }}</td>
                  <td>{{ area.total_customers }}</td>
                  <td>
                    <span class="{% if area.active_customers > 0 %}text-success{% else %}text-gray-400{% endif %}">
                      {{ area.active_customers }}
                    </span>
                  </td>
                  <td class="font-medium">₱{{ area.revenue|floatformat:2|intcomma }}</td>
                  <td>
                    {% if area.tickets > 5 %}
                      <span class="badge badge-error badge-sm">{{ area.tickets }}</span>
                    {% elif area.tickets > 0 %}
                      <span class="badge badge-warning badge-sm">{{ area.tickets }}</span>
                    {% else %}
                      <span class="text-gray-400">0</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="flex items-center gap-2">
                      <div class="w-20 bg-gray-200 rounded-full h-2">
                        <div class="bg-primary h-2 rounded-full" style="width: {{ area.penetration_rate }}%"></div>
                      </div>
                      <span class="text-xs">{{ area.penetration_rate|floatformat:0 }}%</span>
                    </div>
                  </td>
                  <td>
                    <a href="?barangay={{ area.barangay.id }}" class="btn btn-sm btn-ghost">
                      View Details
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}
</div>

{% if selected_barangay %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Monthly Trend Chart for selected area
const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
const monthlyData = {{ selected_stats.monthly_trend|safe }};

new Chart(ctx, {
  type: 'line',
  data: {
    labels: monthlyData.map(d => d.month),
    datasets: [{
      label: 'Monthly Revenue',
      data: monthlyData.map(d => d.revenue),
      borderColor: 'rgb(34, 197, 94)',
      backgroundColor: 'rgba(34, 197, 94, 0.1)',
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          callback: function(value) {
            return '₱' + value.toLocaleString();
          }
        }
      }
    }
  }
});
</script>
{% endif %}
{% endblock %}
