{% extends 'web/app/app_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Monthly Revenue Report - {{ month_name }} {{ year }}{% endblock %}

{% block app %}
<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <a href="{% url 'reports:dashboard' %}" class="btn btn-ghost btn-sm mb-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Reports
      </a>
      <h1 class="text-2xl font-bold text-gray-900">Monthly Revenue Report</h1>
      <p class="text-gray-600">{{ month_name }} {{ year }}</p>
    </div>
    
    <!-- Month/Year Selector -->
    <form method="get" class="flex gap-2">
      <select name="month" class="select select-bordered">
        <option value="1" {% if month == 1 %}selected{% endif %}>January</option>
        <option value="2" {% if month == 2 %}selected{% endif %}>February</option>
        <option value="3" {% if month == 3 %}selected{% endif %}>March</option>
        <option value="4" {% if month == 4 %}selected{% endif %}>April</option>
        <option value="5" {% if month == 5 %}selected{% endif %}>May</option>
        <option value="6" {% if month == 6 %}selected{% endif %}>June</option>
        <option value="7" {% if month == 7 %}selected{% endif %}>July</option>
        <option value="8" {% if month == 8 %}selected{% endif %}>August</option>
        <option value="9" {% if month == 9 %}selected{% endif %}>September</option>
        <option value="10" {% if month == 10 %}selected{% endif %}>October</option>
        <option value="11" {% if month == 11 %}selected{% endif %}>November</option>
        <option value="12" {% if month == 12 %}selected{% endif %}>December</option>
      </select>
      <select name="year" class="select select-bordered">
        <option value="2023" {% if year == 2023 %}selected{% endif %}>2023</option>
        <option value="2024" {% if year == 2024 %}selected{% endif %}>2024</option>
        <option value="2025" {% if year == 2025 %}selected{% endif %}>2025</option>
      </select>
      <button type="submit" class="btn btn-primary">Update</button>
    </form>
  </div>

  <!-- Key Metrics -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Total Revenue -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <h2 class="text-sm text-gray-600">Total Revenue</h2>
        <p class="text-3xl font-bold">₱{{ total_revenue|floatformat:2|intcomma }}</p>
        <p class="text-xs text-gray-500">{{ total_subscriptions }} payments</p>
      </div>
    </div>
    
    <!-- MoM Growth -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <h2 class="text-sm text-gray-600">MoM Growth</h2>
        <p class="text-3xl font-bold {% if mom_growth > 0 %}text-green-600{% elif mom_growth < 0 %}text-red-600{% endif %}">
          {{ mom_growth|floatformat:1 }}%
        </p>
        <p class="text-xs text-gray-500">vs ₱{{ prev_revenue|floatformat:2|intcomma }}</p>
      </div>
    </div>
    
    <!-- YoY Growth -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <h2 class="text-sm text-gray-600">YoY Growth</h2>
        <p class="text-3xl font-bold {% if yoy_growth > 0 %}text-green-600{% elif yoy_growth < 0 %}text-red-600{% endif %}">
          {{ yoy_growth|floatformat:1 }}%
        </p>
        <p class="text-xs text-gray-500">vs last year</p>
      </div>
    </div>
    
    <!-- ARPU -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body">
        <h2 class="text-sm text-gray-600">ARPU</h2>
        <p class="text-3xl font-bold">₱{{ arpu|floatformat:2|intcomma }}</p>
        <p class="text-xs text-gray-500">{{ unique_customers }} unique customers</p>
      </div>
    </div>
  </div>

  <!-- Revenue Split -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- New vs Renewal -->
    <div class="card bg-base-100 shadow-md">
      <div class="card-body">
        <h2 class="card-title text-lg">Revenue Type</h2>
        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <span>New Customers</span>
            <span class="font-bold">₱{{ new_revenue|floatformat:2|intcomma }}</span>
          </div>
          <div class="flex justify-between items-center">
            <span>Renewals</span>
            <span class="font-bold">₱{{ renewal_revenue|floatformat:2|intcomma }}</span>
          </div>
        </div>
        <canvas id="revenueTypeChart" class="mt-4" height="200"></canvas>
      </div>
    </div>
    
    <!-- Daily Revenue Chart -->
    <div class="card bg-base-100 shadow-md">
      <div class="card-body">
        <h2 class="card-title text-lg">Daily Revenue</h2>
        <canvas id="dailyRevenueChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- Revenue by Plan -->
  <div class="card bg-base-100 shadow-md mb-6">
    <div class="card-body">
      <h2 class="card-title text-lg">Revenue by Plan</h2>
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Plan</th>
              <th>Speed</th>
              <th>Count</th>
              <th>Revenue</th>
              <th>% of Total</th>
            </tr>
          </thead>
          <tbody>
            {% for plan in plan_revenue %}
            <tr>
              <td>{{ plan.subscription_plan__name }}</td>
              <td>{{ plan.subscription_plan__speed }} Mbps</td>
              <td>{{ plan.count }}</td>
              <td>₱{{ plan.total|floatformat:2|intcomma }}</td>
              <td>{{ plan.percentage|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Revenue by Barangay -->
  <div class="card bg-base-100 shadow-md">
    <div class="card-body">
      <h2 class="card-title text-lg">Top 10 Barangays by Revenue</h2>
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Barangay</th>
              <th>Payments</th>
              <th>Revenue</th>
              <th>% of Total</th>
            </tr>
          </thead>
          <tbody>
            {% for barangay in barangay_revenue %}
            <tr>
              <td>{{ barangay.customer_installation__customer__barangay__name }}</td>
              <td>{{ barangay.count }}</td>
              <td>₱{{ barangay.total|floatformat:2|intcomma }}</td>
              <td>{{ barangay.percentage|floatformat:1 }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Revenue Type Chart (Pie/Doughnut)
  const revenueTypeCtx = document.getElementById('revenueTypeChart').getContext('2d');
  new Chart(revenueTypeCtx, {
    type: 'doughnut',
    data: {
      labels: ['New Customers', 'Renewals'],
      datasets: [{
        data: [{{ new_revenue|floatformat:2 }}, {{ renewal_revenue|floatformat:2 }}],
        backgroundColor: ['#3B82F6', '#10B981'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
        }
      }
    }
  });

  // Daily Revenue Chart
  const dailyRevenueCtx = document.getElementById('dailyRevenueChart').getContext('2d');
  const dailyData = [
    {% for day in daily_revenue %}
    { x: {{ day.day }}, y: {{ day.revenue }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  new Chart(dailyRevenueCtx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'Daily Revenue',
        data: dailyData,
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderColor: '#3B82F6',
        borderWidth: 2,
        fill: true,
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          type: 'linear',
          title: {
            display: true,
            text: 'Day of Month'
          },
          min: 1,
          max: {{ daily_revenue|length }},
          ticks: {
            stepSize: 1
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Revenue (₱)'
          },
          ticks: {
            callback: function(value) {
              return '₱' + value.toLocaleString();
            }
          }
        }
      }
    }
  });
});
</script>
{% endblock %}
